---
layout: post
title: SLF4J et JCL sous Jonas 5
date: '2010-04-08T11:55:00.004+02:00'
author: Alexis Hassler
tags:
- Jonas
- SLF4J
modified_time: '2010-10-27T22:19:03.307+02:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-4531751515188380606
blogger_orig_url: http://blog.alexis-hassler.com/2010/04/slf4j-et-jcl-sous-jonas-5.html

---

Lors du déploiement d'une application JavaEE, la configuration des logs est un passage obligé. La principale contrainte vient du fait qu'au déploiement, on subit le choix des développeurs : <a href="http://logging.apache.org/log4j/">Log4J</a>, <a href="http://commons.apache.org/logging/">jakarta commons-logging</a> (ou JCL), <a href="http://www.slf4j.org/">SLF4J</a> ou d'autres encore que je&nbsp;m'abstiendrai&nbsp;de citer ici.<br /><br />SLF4J associé à <a href="http://logback.qos.ch/">LogBack</a> est probablement ce qui se fait de mieux aujourd'hui. Il propose d'ailleurs des mécanismes d'interopérabilité avec les autres APIs de Log. Par exemple, dans la dernière application que j'ai déployée, tous les logs envoyés à JCL sont interceptés par SLF4J grâce à la librairie&nbsp;jcl-over-slf4j.jar. A l'inverse, <a href="http://jonas.ow2.org/">Jonas 5.1</a> renvoie tous les logs de SLF4J vers JCL.<br /><br /><!--more--><br /><br />Là où ça se corse, c'est quand je déploie mon application dans Jonas : l'application renvoie les logs JCL dans SLF4J qui sont renvoyés dans JCL par Jonas, ainsi de suite jusqu'à la levée d'une&nbsp;StackOverflowError. Le StackTrace ci dessous est tronqué car, sur ma machine, il fait presque 7000 lignes !<br /><br /><pre>java.lang.StackOverflowError<br />  at sun.reflect.Reflection.getCallerClass(Native Method)<br />  at java.lang.ClassLoader.getCallerClassLoader(ClassLoader.java:1359)<br />  at java.lang.Class.getMethod(Class.java:1602)<br />  at org.apache.commons.logging.LogFactory.directGetContextClassLoader(LogFactory.java:825)<br />  at org.apache.commons.logging.LogFactory$1.run(LogFactory.java:791)<br />  at org.apache.commons.logging.LogFactory.getContextClassLoader(LogFactory.java:788)<br />  at org.apache.commons.logging.LogFactory.getFactory(LogFactory.java:383)<br />  at org.apache.commons.logging.LogFactory.getLog(LogFactory.java:664)<br />  at org.slf4j.impl.JCLLoggerFactory.getLogger(JCLLoggerFactory.java:69)<br />  at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:243)<br />  at org.apache.commons.logging.impl.SLF4JLogFactory.getInstance(SLF4JLogFactory.java:155)<br />  at org.apache.commons.logging.LogFactory.getLog(LogFactory.java:664)<br />  at org.slf4j.impl.JCLLoggerFactory.getLogger(JCLLoggerFactory.java:69)<br />  at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:243)<br />  at org.apache.commons.logging.impl.SLF4JLogFactory.getInstance(SLF4JLogFactory.java:155)<br />  at org.apache.commons.logging.LogFactory.getLog(LogFactory.java:664)<br />  at org.slf4j.impl.JCLLoggerFactory.getLogger(JCLLoggerFactory.java:69)<br />  at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:243)<br />  ...<br /></pre><br />Il existe deux types de solutions à un tel problème : ne plus rediriger SLF4J vers JCL ou l'inverse. Dans mon cas, le plus simple serait de supprimer&nbsp;jcl-over-slf4j.jar de mon application et JCL fonctionnerait normalement.&nbsp;Ça&nbsp;signifie que je devrais aussi me passer de LogBack, idée qui me déplait fortement.<br /><br />Pour la solution inverse, je dois indiquer à Jonas que les classes de SLF4J fournies par Jonas doivent être utilisée uniquement pour Jonas lui-même et pas par les applications déployées. Ceci se configure par un <a href="http://jonas.ow2.org/JONAS_5_1_1/doc/doc-en/html/j2eeprogrammerguide.html#id1309628">filtre de classloading</a>, dans le fichier conf/classloader-default-filtering.xml :<br /><br /><pre class="brush:xml">&lt;class-loader-filtering xmlns="http://org.ow2.jonas.lib.loader.mapping"&gt;<br />  &lt;default-filters&gt;<br />    &lt;filter-name&gt;org.apache.commons.digester.*&lt;/filter-name&gt;<br />    &lt;filter-name&gt;org.slf4j.*&lt;/filter-name&gt;<br />  &lt;/default-filters&gt;<br />&lt;/class-loader-filtering&gt;<br /></pre><br />Avec cette modification au niveau de la configuration de Jonas, je n'ai plus de soucis avec SLF4J. Je pense même que dorénavant, je ferai systématiquement cette modification.<br /><br />PS : merci à Guillaume Sauthier pour son aide, sur la <a href="http://jonas.ow2.org/wws/info/jonas-fr">mailing-list jonas-fr</a>.