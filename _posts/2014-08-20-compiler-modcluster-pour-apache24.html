---
layout: post
title: 'Compiler mod_cluster pour Apache 2.4 : pourquoi et comment ?'
date: '2014-08-20T08:30:00.000+02:00'
author: Alexis Hassler
tags:
- mod_cluster
- apache
- build
modified_time: '2014-08-20T10:07:20.290+02:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-4893670767870385179
blogger_orig_url: http://blog.alexis-hassler.com/2014/08/compiler-modcluster-pour-apache24.html

---

Le module Apache <a href="http://mod-cluster.jboss.org/" target="_blank">mod_cluster</a> est un&nbsp;<b>load balancer</b>&nbsp;pour <b>WildFly</b> (ou JBoss AS). La grande différence avec les classiques mod_proxy ou mod_jk est son coté dynamique. Il détecte les instances de WildFly par multicast. Et si le multicast n'est pas accepté, ce sont les instances WildFly qui viennent s'enregistrer auprès du module. Bref, mod_cluster permet de gérer un environnement dynamique, avec une <a href="http://www.jtips.info/index.php?title=Apache/mod_cluster" target="_blank">configuration légère</a>.<br /><br />Le problème, c'est qu'au moment de rédiger ce billet, la page de téléchargement de mod_cluster ne propose que des binaires pour <b>Apache 2.2</b>, et dans une <b>version obsolète</b> (1.2.6 alors qu'il existe une 1.3.0 et une 1.2.9). La seule solution, c'est donc de compiler soi-même, la version qu'on souhaite (1.3 pour WildFly, 1.2 pour JBoss AS 7), dans l'environnement que je souhaite (Apache 2.4 sur Linux).<br /><br /><!--more--><br />Evidemment, un module Apache ce n'est pas du Java, mais du C. Il n'y a donc pas de Maven... Ceci dit, la procédure est très simple à partir du moment où on respecte quelques pré-requis.<br /><br /><b>Pré-requis</b><br /><br />Tout d'abord, il faut quelques packages de dev :&nbsp;autoconf, libtool et git. Il faut aussi Apache avec son package de dev prefork, pour apxs.<br /><br /><pre class="brush:bash">apt-get update<br />apt-get install -y autoconf libtool git apache2<br />apt-get remove apache2-threaded-dev<br />apt-get install -y apache2-prefork-dev</pre><br /><span style="font-size: x-small;">Ces packages sont valables sur les 2 systèmes que j'ai testés : Debian Jessie et Ubuntu 14.04.</span><br /><br /><b>Compilation</b><br /><br />Tout est prêt, on doit alors récupérer le code source.<br /><br /><pre class="brush:bash">git clone https://github.com/modcluster/mod_cluster.git<br />git checkout 1.3.0.Final<br />cd mod_cluster</pre><br />On peut lancer alors le build. Ou plutôt les builds puisqu'il y a plusieurs modules et un build par module&nbsp;: mod_advertise, mod_manager, mod_proxy_cluster et mod_cluster_slotmem.<br /><br /><pre class="brush:bash">cd native/advertise<br />./buildconf<br />./configure --with-apxs=/usr/bin/apxs<br />make</pre><pre class="brush:bash">cd ../mod_manager<br />./buildconf<br />./configure --with-apxs=/usr/bin/apxs<br />make</pre><pre class="brush:bash">cd ../mod_proxy_cluster<br />./buildconf<br />./configure --with-apxs=/usr/bin/apxs<br />make</pre><pre class="brush:bash">cd ../mod_cluster_slotmem<br />./buildconf<br />./configure --with-apxs=/usr/bin/apxs<br />make<br /></pre><br />Attention, les noms des répertoires et des modules peuvent varier d'une version mineur à l'autre. Les noms utilisés ici sont valables pour la version 1.3.0. Pour la version 1.2.9, il faut remplacer mod_cluster_slotmem par mod_slotmem.<br /><br /><b>Installation</b><br /><br />A l'issue de la compilation, on a un fichier .so pour chaque module qu'il faut copier dans le répertoire des modules d'Apache.<br /><br /><pre class="brush:bash">cp native/advertise/*.so /usr/lib/apache2/modules/<br />cp native/mod_manager/*.so /usr/lib/apache2/modules/<br />cp native/mod_proxy_cluster/*.so /usr/lib/apache2/modules/<br />cp native/mod_cluster_slotmem/*.so /usr/lib/apache2/modules/<br /></pre><div><br />Enfin, ces modules doivent être chargés, par exemple avec un fichier&nbsp;<span style="background-color: #f9f9f9; line-height: 1.1em;">/etc/apache2/mods-available/proxy_cluster.load qui contient les lignes suivantes :</span><br /><br /><pre class="brush:bash">LoadModule advertise_module /usr/lib/apache2/modules/mod_advertise.so<br />LoadModule manager_module /usr/lib/apache2/modules/mod_manager.so<br />LoadModule proxy_cluster_module /usr/lib/apache2/modules/mod_proxy_cluster.so<br />LoadModule slotmem_module /usr/lib/apache2/modules/mod_cluster_slotmem.so<br /></pre><br />Pour finir, la configuration de mod_cluster étant la même que pour Apache 2.2, on peut suivre la <a href="http://docs.jboss.org/mod_cluster/1.2.0/html/" target="_blank">documentation</a>. Ci-dessous, j'ai mis un exemple simple de configuration (avec mod_cluster et WildFly sur la même machine).<br /><br /><pre class="brush:xml">Listen 127.0.0.1:6666<br />&lt;virtualhost 127.0.0.1:6666&gt;<br />&nbsp; &lt;location&gt;<br />&nbsp; &nbsp; Require ip 127.0.0.1<br />&nbsp; &lt;/location&gt;<br />&nbsp; KeepAliveTimeout 60<br />&nbsp; MaxKeepAliveRequests 0<br />&nbsp; ManagerBalancerName mycluster<br />&nbsp; ServerAdvertise On<br />&nbsp; EnableMCPMReceive<br />&lt;/VirtualHost&gt;<br />MemManagerFile /var/log/apache2/<br />&lt;location cluster-manager&gt;<br />&nbsp; SetHandler mod_cluster-manager<br />&nbsp; Require all granted<br />&lt;/location&gt;</pre>Vous pouvez maintenant utiliser les dernières versions de mod_cluster, avec les dernières versions de Apache.</div>