---
layout: post
title: Authentification Digest et chiffrement des mots de passe, avec Tomcat Realm
date: '2015-10-26T08:30:00.000+01:00'
author: Alexis Hassler
tags:
- Digest
- Tomcat
- Realm
modified_time: '2015-12-04T12:04:48.018+01:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-1957912836109873042
blogger_orig_url: http://blog.alexis-hassler.com/2015/10/tomcat-realm-digest.html

---

<a href="https://images-blogger-opensocial.googleusercontent.com/gadgets/proxy?url=http%3A%2F%2Ftomcat.apache.org%2Fimages%2Ftomcat.png&amp;container=blogger&amp;gadget=a&amp;rewriteMime=image%2F*" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="//tomcat.apache.org/images/tomcat.png" /></a>Le mois dernier, j'avais écrit un billet sur l'<a href="https://blog.alexis-hassler.com/2015/10/spring-boot-digest.html" target="_blank">authentification Digest et le chiffrement des mots de passe, avec Spring Security</a>. Aujourd'hui je me pose la même question, mais avec une configuration de Realm sous Tomcat 8. <div>Comment peux-t-on associer une authentification Digest avec le hachage des mots de passe ? Nous verrons d'ailleurs que la réponse n'est pas la même pour tous les realms de Tomcat. </div><!--more--><h4>Tomcat Realm</h4><div>Sous <a href="http://tomcat.apache.org/" target="_blank">Tomcat</a>, on configure des <a href="https://tomcat.apache.org/tomcat-8.0-doc/realm-howto.html" target="_blank">Realms</a> qui accèdent à des sources de données pour valider le nom d'utilisateur et le mot de passe, ainsi que pour attribuer un ou plusieurs rôles à l'utilisateur authentifié. Par exemple, dans la configuration par défaut, on a le UserDatabaseRealm qui utilise les données stockées dans le fichier conf/tomcat-users.xml. </div><pre class="brush:xml">&lt;tomcat-users&gt;<br />  &lt;user username="myuser" <br />        password="ceaf8439...$1$61057e0429b934189c46ea23c9f23..." <br />        roles="myrole" /&gt;<br />&lt;/tomcat-users&gt;<br /></pre><div>En ajoutant l'attribut digest à la configuration du Realm, on peut lui dire que le mot de passe est haché. </div><pre class="brush:xml">&lt;realm classname="org.apache.catalina.realm.UserDatabaseRealm" <br />       resourceName="UserDatabase" digest="sha-512" /&gt;<br /></pre><div>Tomcat fournit même le script bin/digest.sh pour hacher nos mots de passe. </div><pre class="brush:bash">$CATALINA_HOME/bin/digest.sh -a sha-512 mypwd<br /></pre><div><h4>CredentialHandler vs digest</h4>Dans cet exemple, j'ai utilisé l'ancien format de configuration. Celui-ci est valable jusqu'à Tomcat 7, mais est déprécié dans Tomcat 8 et devrait être retiré de Tomcat 9. Pour préparer l'avenir, je préfère le nouveau format, avec un CredentialHandler. L'appel du script digest.sh et le format de stockage du user n'ont pas changé. </div><pre class="brush:xml">&lt;realm classname="org.apache.catalina.realm.UserDatabaseRealm" <br />       resourceName="UserDatabase" &gt;<br />  &lt;credentialhandler&nbsp;<br />         className="org.apache.catalina.realm.MessageDigestCredentialHandler"&nbsp;<br />         algorithm="sha-512" /&gt;<br />&lt;/realm&gt;<br /></pre><h4>Authentification HTTP Digest</h4><div>Cette façon de stocker le mot de passe fonctionne bien si mon application est en authentification Basic ou par formulaire, mais ne marche pas en Digest. Pour la rendre compatible en Digest, il faut que passer en algorithme MD5 et hacher la concaténation du username, du realm name de l'application et du mot de passe (username:realm:password).  </div><div>Pour l'application manager, on commence par exécuter ce script : </div><pre class="brush:bash">bin/digest.sh -a md5 -s 0 admin:Tomcat\ Manager\ Application:admpwd<br /></pre><div>Puis on enregistre le résultat dans le fichier <b>tomcat-users.xml</b> : </div><pre class="brush:xml">&lt;tomcat-users&gt;<br />  &lt;user username="myuser" <br />        password="62c6ce725d29073d5a8affb1820c4a59" <br />        roles="manager-gui"/&gt;<br />&lt;/tomcat-users&gt;<br /></pre><div>Enfin, on ajoute le <b>MD5</b> au realm : </div><pre class="brush:xml">&lt;realm classname="org.apache.catalina.realm.UserDatabaseRealm" <br />       resourceName="UserDatabase" &gt;<br />  &lt;credentialhandler <br />         className="org.apache.catalina.realm.MessageDigestCredentialHandler" <br />         algorithm="md5" /&gt;<br />&lt;/realm&gt;<br /></pre><h4>DatasourceRealm</h4><div>Évidemment, ça fonctionne avec d'autres realms, comme le <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/realm.html#DataSource_Database_Realm_-_org.apache.catalina.realm.DataSourceRealm" target="_blank">DataSourceRealm<span id="goog_551274344"></span><span id="goog_551274345"></span></a> qui cherche les informations en base de données. Je le configure de la même façon que pour stocker les mots de passe en clair, avec le CredentialHandler <b>MD5</b> en plus. </div><pre class="brush:xml">&lt;Realm className="org.apache.catalina.realm.DataSourceRealm"<br />       dataSourceName="jdbc/sewa-global-ds"<br />       userTable="SW_USERS" userNameCol="USERID" userCredCol="PASSWD"<br />       userRoleTable="SW_ROLES" roleNameCol="ROLEID"/&gt;<br />  &lt;CredentialHandler <br />         className="org.apache.catalina.realm.MessageDigestCredentialHandler" <br />         algorithm="md5" /&gt;<br />&lt;/realm&gt;<br /></pre><div>On doit ensuite enregistrer le hash dans la colonne PASSWD : </div><pre class="brush:sql">INSERT INTO SW_USERS (USERID, PASSWD) <br />    VALUES ('myuser', '62c6ce725d29073d5a8affb1820c4a59');<br /></pre><h4>JNDIRealm</h4><div>Malheureusement, ce qu'on vient de voir ne marche pas avec le <a href="https://tomcat.apache.org/tomcat-8.0-doc/config/realm.html#JNDI_Directory_Realm_-_org.apache.catalina.realm.JNDIRealm" target="_blank">JNDIRealm</a> qui valide les authentifications auprès d'un annuaire LDAP. Mais ça, il faudrait que j'en parle dans un autre billeT. <b>A SUIVRE...</b></div>