---
layout: post
title: Mots de passe chiffrés pour les datasources de JBoss
date: '2011-02-24T21:25:00.006+01:00'
author: Alexis Hassler
tags:
- JBoss
modified_time: '2011-06-21T18:10:51.671+02:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-1353407310013830915
blogger_orig_url: http://blog.alexis-hassler.com/2011/02/mots-de-passe-chiffres-pour-les.html

---

Dans JBoss, les datasources sont configurées dans des fichiers XML qui contiennent les paramètres de connexion et la configuration du pool. Parmi les paramètres de connexion, on trouve le nom d'utilisateur et le mot de passe, en clair...<br /><pre class="brush:xml">&lt;local-tx-datasource&gt;<br />&nbsp;&nbsp;&nbsp; &lt;jndi-name&gt;SewaDS&lt;/jndi-name&gt;<br />&nbsp;&nbsp;&nbsp; &lt;connection-url&gt;jdbc:derby://localhost:1527/sewadb&lt;/connection-url&gt;<br />&nbsp;&nbsp;&nbsp; &lt;driver-class&gt;org.apache.derby.jdbc.ClientDriver&lt;/driver-class&gt;<br />&nbsp;&nbsp;&nbsp; &lt;user-name&gt;sewatech&lt;/user-name&gt;<br />&nbsp;&nbsp;&nbsp; &lt;password&gt;sewapwd&lt;/password&gt;<br />&lt;local-tx-datasource&gt;<br /></pre>Évidemment, ce mot de passe en clair n'est pas la panacée et déclenchera une levée de bouclier au prochain audit de sécurité.<br /><br />Il existe plusieurs <a href="http://community.jboss.org/wiki/encryptingdatasourcepasswords">techniques pour chiffrer le mot de passe</a>. Je vais parler ici de la technique du SecureIdentityLoginModule, qui, si elle n'est pas la plus sécurisée, est simple et rapide à mettre en place. Si je veux en parler ici, c'est que malgré sa simplicité, je suis tombé récemment dans un vilain piège.<br /><br /><!--more--><br />Les modules d'identité, ConfiguredIdentityLoginModule et SecureIdentityLoginModule, sont utilisés pour externaliser les informations d'authentification des datasources ou d'autres services JBoss. Ce sont des modules JAAS un peu particuliers qui fournissent un couple login / password au lieu de le vérifier. Comme les autres modules JAAS, ils se configurent dans le fichier conf/login-config.xml :<br /><pre class="brush:xml">&lt;application-policy name="SewaDSRealm"&gt;<br />&nbsp; &lt;authentication&gt;<br />&nbsp;&nbsp;&nbsp; &lt;login-module&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; code="org.jboss.resource.security.ConfiguredIdentityLoginModule"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flag="required"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="principal"&gt;Sewatech&lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="userName"&gt;sewatech&lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="password"&gt;sewapwd&lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="managedConnectionFactoryName"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jboss.jca:service=LocalTxCM,name=SewaDS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/login-module&gt;<br />&nbsp; &lt;/authentication&gt;<br /> &lt;/application-policy&gt;</pre>ou, pour la version chiffrée,<br /><pre class="brush:xml">&lt;application-policy name="EncryptedSewaDSRealm"&gt;<br />&nbsp; &lt;authentication&gt;<br />&nbsp;&nbsp;&nbsp; &lt;login-module <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; code="org.jboss.resource.security.SecureIdentityLoginModule"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flag="required"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="principal"&gt;Sewatech&lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="userName"&gt;sewatech&lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="password"&gt;-27620c55b0b41646&lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;module-option name="managedConnectionFactoryName"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jboss.jca:service=LocalTxCM,name=SewaDS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/module-option&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/login-module&gt;<br />&nbsp; &lt;/authentication&gt;<br />&lt;/application-policy&gt;</pre>Le mot de passe chiffré a été obtenu avec la commande suivante :<br /><pre class="brush:shell">java -cp client/jboss-logging-spi.jar:common/lib/jbosssx.jar <br />     org.jboss.resource.security.SecureIdentityLoginModule sewapwd</pre>Dans JBoss AS 6, et dans JBoss EAP 5.1 patché, le fichier jbosssx.sar a été déplacé du répertoire common/lib/ vers lib/.<br /><br />Enfin, la nouvelle version de la datasource, utilisant ce module ressemble à :<br /><pre class="brush:xml">&lt;local-tx-datasource&gt;<br />&nbsp; &lt;jndi-name&gt;SewaDS&lt;/jndi-name&gt;<br />&nbsp; &lt;connection-url&gt;jdbc:derby://localhost:1527/sewadb&lt;/connection-url&gt;<br />&nbsp; &lt;driver-class&gt;org.apache.derby.jdbc.ClientDriver&lt;/driver-class&gt;<br />&nbsp; &lt;security-domain&gt;EncryptedSewaDSRealm&lt;/security-domain&gt;<br />&lt;local-tx-datasource&gt;<br /></pre>Et voilà. Comment peut-on tomber dans un vilain piège avec une telle simplicité ? Le premier piège, c'est que dans toutes les applications, lorsqu'on déclare un SecurityDomain, on le préfixe par java:/jaas/ ; pas ici. Le deuxième piège est beaucoup plus sournois.<br /><br />Mon mot de passe sewapwd est trop simple, il faut lui augmenter la variété de caractères ; $ew@pw2 sera beaucoup mieux. Je change donc mon mot de passe en base, puis je le chiffre et je modifie la configuration du module. Et là patatra, ma datasource n'arrive plus à s'authentifier auprès de la base de données. C'est le caractère '$' qui est en cause. Je ne connais pas exactement la raison, mais il faut l'échapper :<br /><pre class="brush:shell">java -cp client/jboss-logging-spi.jar:common/lib/jbosssx.jar <br />     org.jboss.resource.security.SecureIdentityLoginModule \$ew@pw2</pre>En mettant la valeur chiffrée ainsi, la datasource peut à nouveau se connecter.