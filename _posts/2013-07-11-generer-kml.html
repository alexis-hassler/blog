---
layout: post
title: Générer un document KML pour Google Maps
date: '2013-07-11T00:50:00.000+02:00'
author: Alexis Hassler
tags:
- KML
- Google Maps
modified_time: '2013-07-11T11:08:29.983+02:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-7633289495620379186
blogger_orig_url: http://blog.alexis-hassler.com/2013/07/generer-kml.html

---

Dans mon article précédent, j'expliquais comment j'avais obtenu des <a href="http://blog.alexis-hassler.com/2013/07/du-sig-google-maps.html">coordonnées géographiques à partir de coordonnées Lambert 93</a>. La dernière étape pour valider la conversion était la soumission d'une carte au client.<br /><br />Pour afficher ses points sur Google Maps, sans passer par l'API, j'ai choisi de passer par un fichier KML. Je dois générer un tel fichier à partir des points convertis, en utilisant la longitude et la latitude, puis je dois rendre ce fichier accessible sur le Web et enfin, je passe l'URL du fichier en paramètre à Google Maps.<br /><br /><!--more-->Pour générer le fichier KML, je pars d'un fichier CSV contenant tous les points à afficher. Pour l'article, j'utilise un fichier contenant la liste des communes de France, avec leurs coordonnées et leurs populations.<br /><br /><pre class="brush:plain">01001,L'Abergement-Clémenciat,01400,46.15,4.916667,579<br />01002,L'Abergement-de-Varey,01640,46.0,5.416667,159<br />01003,Amareins,01090,46.083333,4.8,0<br />01004,Ambérieu-en-Bugey,01500,45.95,5.35,10455<br />01005,Ambérieux-en-Dombes,01330,46.0,4.9,1156<br />01006,Ambléon,01300,45.75,5.6,76<br /></pre><br />Je vais donc charger ce fichier, découper chaque ligne et générer un Placemark KML pour chacune d'entre elles. Pour la génération KML, j'utilise la librairie <a href="https://code.google.com/p/javaapiforkml/">JAK</a>, ou&nbsp;Java API for KML. Donc avant d'entrer dans le code, quelques mots sur la librairie.<br /><br />Le premier abord est bien meilleur que pour proj4j : <a href="http://search.maven.org/#browse%7C-469414455">artefact dans le repository central de Maven</a> et <a href="http://labs.micromata.de/display/jak/Home">un peu de doc</a>. Par contre, je ne trouve pas l'API très intuitive ; certainement un effet de mon manque de vocabulaire, là aussi.<br /><br />Allez, un peu de code. Je commence par charger mon fichier CSV.<br /><div style="text-align: left;"><script class="brush: java" type="syntaxhighlighter"><![CDATA[ Path file = Paths.get("data", "cities.csv"); List<string> lines = readAllLines(file, Charset.forName("UTF-8")); ]]></script>Puis je prépare mon document KML, on déclarant deux styles. Ça permettra de mettre des icônes différentes selon la taille des communes. <script class="brush: java" type="syntaxhighlighter"><![CDATA[ Kml kml = new Kml(); Document kmlDocument = kml.createAndSetDocument(); kmlDocument.getStyleSelector().addAll(asList(City.SMALL_STYLE, City.BIG_STYLE)); ]]></script>Ensuite, por chaque ligne je crée un objet City, je retire les objets null, ainsi que les villes trop petites (ça ferait trop de points sur la carte avec toutes les communes) et je crée transforme la City en Placemark. J'ajoute la liste de Feature ainsi obtenue au document. <script class="brush: java" type="syntaxhighlighter"><![CDATA[ kmlDocument.setFeature(     from(lines)         .transform(City.fromLine)         .filter(notNull())         .filter(not(tooSmall))         .transform(City.toPlacemark)         .toList()); ]]></script>Enfin, je génère un fichier KMZ, qui est un document KML zippé. <script class="brush: java" type="syntaxhighlighter"><![CDATA[ kml.marshalAsKmz("data/" + "cities.kmz"); ]]></script> Le travail est presque terminé. Il me reste à rendre ce fichier consultable sur le Web ; par exemple dans le répertoire public de mon compte DropBox. Les points seront affichés en passant l'URL du fichier KMZ en paramètre de Google Maps :</div><div style="text-align: center;"><a href="https://maps.google.fr/?q=https://dl.dropboxusercontent.com/u/2133194/cities.kmz" target="_blank">https://maps.google.fr/?q=https://dl.dropboxusercontent.com/u/2133194/cities.kmz</a></div><br /><b>Remarque</b> : je n'ai pas fait le choix d'exclure les communes trop petites que pour la lisibilité ; je l'ai aussi fait parce que Google Maps refusait d'afficher le fichier complet pour cause de dépassement des limites.<br /><b>Autre remarque</b>&nbsp;: en utilisant <a href="https://support.google.com/fusiontables" target="">Google Tables</a>, j'aurais pu afficher les mêmes données dans Google Maps, sans les contraintes de taille ; par contre, c'est un clicodrome, ce qui est moins amusant que faire du code.