---
layout: post
title: Comment chiffrer les mots de passe de Tomcat
date: '2014-10-13T09:30:00.000+02:00'
author: Alexis Hassler
tags:
- Tomcat
- Password
- DataSource
- Realm
modified_time: '2015-12-04T11:24:06.199+01:00'
thumbnail: "//4.bp.blogspot.com/-XV6b3qit4FQ/VDbbvcj11-I/AAAAAAAAFCg/-SbDC3AJGVA/s72-c/SafeWalletLogo.png"
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-1711342653536638554
blogger_orig_url: http://blog.alexis-hassler.com/2014/10/tomcat-chiffrer-les-mots-de-passe.html

---

<br /><div class="separator" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em; text-align: center;"><img border="0" src="//4.bp.blogspot.com/-XV6b3qit4FQ/VDbbvcj11-I/AAAAAAAAFCg/-SbDC3AJGVA/s1600/SafeWalletLogo.png" height="200" width="200" /></div><br />Dans la configuration de Tomcat, on a 2 catégories de mots de passe : dans les <b>Realms</b> et dans les <b>DataSources</b>. Les realms sont utilisés pour l'authentification des utilisateurs, ils stockent généralement leurs mots de passe à l'extérieur comme par exemple dans le fichier tomcat-users.xml. Les&nbsp;DataSources&nbsp;sont configurées&nbsp;dans le fichier de configuration principal, server.xml, ou dans chaque application dans META-INF/context.xml.<br /><br />Par défaut, tous ces mots de passe sont stockés en clair. Nous allons voir dans quelle mesure il est possible de les chiffrer.<br /><br /><!--more-->Commençons par les R<b>ealms</b>. On prendra le realm par défaut comme exemple, mais tout ce qu'on verra pourra s'appliquer à d'autres realms, comme le DataSourceRealm. D'ailleurs, je n'ai pas eu à chercher très loin puisque la technique est décrite dans la <a href="http://tomcat.apache.org/tomcat-8.0-doc/realm-howto.html#Digested_Passwords" target="_blank">doc de Tomcat</a>.<br /><div><br />L'idée, c'est donc de <i>digérer</i>&nbsp;le mot de passe, ainsi il sera chiffré de façon non réversible. Les algorithmes utilisables sont md5, sha1, sha-256, sha-384 et sha-512. On stockera le mot de passe en version chiffrée, pour le générer on peut utiliser le script bin/digest.sh.<br /><br /><pre class="brush:bash">$ bin/digest.sh -a sha1 s3cr3t<br />s3cr3t:25ab86bed149ca6ca9c1c0d5db7c9a91388ddeab<br /></pre><br />On enregistre le mot de passe chiffré dans conf/tomcat-users.xml :<br /><br /><pre class="brush:xml">&lt;user username="alexis"&nbsp;<br />      password="25ab86bed149ca6ca9c1c0d5db7c9a91388ddeab" <br />      roles="..." /&gt;<br /></pre><br />Dans la configuration (conf/server.xml), on précisera l'algorithme de chiffrement :<br /><br /><pre class="brush:xml">&lt;realm classname="org.apache.catalina.realm.UserDatabaseRealm"<br />       resourceName="UserDatabase"<br />       digest="sha-512" /&gt;<br /></pre><br />Voilà pour le realm. Ça manque un peu de sel, mais c'est mieux que rien.<br /><br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="//upload.wikimedia.org/wikipedia/commons/7/7b/Tomcat-logo.svg" height="133" width="200" /></div>Passons maintenant à la <b>DataSource</b>. La question est plus sensible puisque nous devrons chiffrer le mot de passe de façon reversible, pour pouvoir le passer en clair à la base de données. Or stocker un mot de passe avec chiffrement réversible, avec la classe qui déchiffre au même endroit, peut sembler inutile. C'est d'ailleurs désigné comme tel dans un <a href="http://wiki.apache.org/tomcat/FAQ/Password" target="_blank">FAQ de Tomcat</a>&nbsp;et c'est la raison pour laquelle Tomcat n'implémente aucune solution de chiffrement.<br /><br />Mon avis est légèrement différent. Même si le gain en sécuté est faible, son coût est faible et ça peut éviter qu'une personne mémorise un mot de passe aperçu. C'est encore plus utile si on utilise la DataSource par défaut, puisque dans ce cas, le mot de passe est aussi visible via JMX, dans jconsole ou par jmxproxy. Par exemple, sur mon serveur, j'ai une DataSource nommée jdbc/sewa-global-ds. Je peux récupérer son mot de passe avec la requête&nbsp;<span style="font-family: Courier New, Courier, monospace;">http://myserver:8080/manager/jmxproxy?get=Catalina:type=DataSource,class=javax.sql.DataSource,name=%22jdbc/sewa-global-ds%22&amp;att=password</span>. Evidemment, ça veut dire qu'il avant tout faut sécuriser le manager : authentification&nbsp;+ SSL.<br /><br />Avec les Tomcat modernes, on peut facilement éviter ça. Il suffit d'utiliser la DataSource de <a href="http://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html" target="_blank">Tomcat JDBC</a>, en ajoutant à notre configurationde DataSource l'attribut <span style="font-family: Courier New, Courier, monospace;">factory=org.apache.tomcat.jdbc.pool.DataSourceFactory</span>. Ainsi, lorsqu'on interroge l'attribut password, on obtient <i>"</i><span style="white-space: pre-wrap;"><i>Password not available as DataSource/JMX operation.</i></span><i>"</i>. Ça limite le risque de diffusion.<br /><br />Pour avoir des mots de passe chiffrés, on peut implémenter notre propre factory, qui hérite de DataSourceFactory et qui déchiffre le mot de passe au démarrage. J'ai développé une telle classe dont vous pouvez voir le code source sur <a href="https://github.com/Sewatech/swutils/tree/master/tc-utils" target="_blank">github</a>. Vous pouvez aussi récupérer le fichier jar sur Maven Central :&nbsp;<a href="http://search.maven.org/remotecontent?filepath=fr/sewatech/utils/tc-utils/0.2.0/tc-utils-0.2.0.jar" target="_blank">fr.sewatech.utils:tc-utils</a>. Vous placez le fichier jar dans le répertoire lib de Tomcat, et vous configurez la datasource comme celle de Tomcat JDBC, avec deux différences :<br /><ul><li><span style="font-family: Courier New, Courier, monospace;">factory="fr.sewatech.tcutils.jdbc.EncryptedDataSourceFactory"</span></li><li><span style="font-family: Courier New, Courier, monospace;">password="XiGY7vFU1Nc="&nbsp;</span></li></ul>Pour obtenir le mot de passe chiffré, il faut exécuter la commande suivante :<br /><br /><pre class="brush:bash">java -cp lib/*:bin/tomcat-juli.jar fr.sewatech.tcutils.jdbc.EncryptedDataSourceFactory encode s3cr3t<br /></pre><br />C'est la fin du mot de passe en clair dans Tomcat. Et si le fait que me classe soit en clair sur GitHub et que tout le monde puisse voir que le chiffrement est du blowfish&nbsp;+ base64, et que la clé est "Sewatech FTW ...", alors faites votre propre factory.<br /><br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="//4.bp.blogspot.com/-s2crPqOd7LA/VDbXFesx5AI/AAAAAAAAFCU/qacZRzmWFLI/s1600/blowfish.png" height="157" width="200" /></div></div>