---
layout: post
title: Script de création de machine virutelle VirtualBox
date: '2010-02-11T14:15:00.006+01:00'
author: Alexis Hassler
tags:
- VirtualBox
modified_time: '2011-01-25T19:10:36.362+01:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-8250411135352154805
blogger_orig_url: http://blog.alexis-hassler.com/2010/02/script-de-creation-de-machine-virutelle.html

---

J'utilise régulièrement des machines virtuelles pour évaluer des produits ou pour élaborer des procédures d'installation. Ce procédé a plein d'avantages, comme pouvoir transférer le résultat sur d'autres machines, repartir facilement d'un environnement vierge ou ne pas polluer mon environnement de travail.<br /><br />J'utilise un nombre restreint de configurations types. Par exemple, pour toutes les installations de type serveur (JBoss, Glassfish, Hudson CI,...), j'ai configuré une Debian avec Java, MySQL et quelques autres logiciels. Chaque fois que j'en ai besoin, je fais une copie de l'environnement étalon et je travaille sur cette copie. <br /><br />Le principal défaut de cette procédure est que la duplication de disque virtuel est facile à réaliser, mais pas la duplication de la configuration. J'ai donc décidé de faire un script shell pour automatiser la création de nouvelles machines virtuelles à partir du disque étalon.<br /><br /><!--more--><br /><br />Pour créer la machine virtuelle :<br /><pre class="brush: shell">#!/bin/sh<br />vbox_home=`pwd`/`dirname $0`<br />vm_name=$1<br />vdi_file=$vbox_home/VDI/$(echo $vm_name | tr "[:upper:]" "[:lower:]").vdi<br /><br /># Création du disque dur<br />echo "Creating virtual hard drive disk file ($vdi_file)"<br />cp $vbox_home/VDI/deb5-server.vdi $vdi_file<br />VBoxManage internalcommands sethduuid $vdi_file<br />echo "Opening virtual hard drive disk ($vdi_file)"<br />VBoxManage openmedium disk $vdi_file<br /><br /># Création de la machine virtuelle<br />echo "Creating virtual machine $vm_name"<br />VBoxManage createvm --name $vm_name --basefolder $vbox_home/Machines/ --ostype Debian --register<br />VBoxManage modifyvm $vm_name --memory 512 <br />VBoxManage modifyvm $vm_name --nic2 hostonly --hostonlyadapter2 vboxnet0<br /><br />echo "Attaching hdd to the virtual machine"<br />VBoxManage storagectl $vm_name --name "Contrôleur IDE" --add ide<br />VBoxManage storageattach $vm_name --storagectl "Contrôleur IDE" --port 0 --device 0 --type hdd --medium $vdi_file<br /><br />echo "Adding shared folders"<br />VBoxManage sharedfolder add $vm_name --name "stockage" --hostpath ~/stockage --readonly<br />VBoxManage sharedfolder add $vm_name --name "tmp" --hostpath ~/stockage/tmp<br /></pre><br />Pour supprimer la machine virtuelle :<br /><pre class="brush: shell">#!/bin/sh<br />vbox_home=`pwd`/`dirname $0`<br />vm_name=$1<br />vdi_file=$vbox_home/VDI/$(echo $vm_name | tr "[:upper:]" "[:lower:]").vdi<br /><br />echo "Removing virtual machine ($vm_name)"<br />VBoxManage storageattach $vm_name --storagectl "Contrôleur IDE" --port 0 --device 0 --type hdd --medium none<br />VBoxManage unregistervm $vm_name --delete<br />echo "Removing virtual hard drive disk  ($vdi_file)"<br />VBoxManage closemedium disk $vdi_file --delete<br /></pre>