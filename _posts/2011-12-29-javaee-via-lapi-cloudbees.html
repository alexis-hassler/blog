---
layout: post
title: Déployer une application JavaEE via l'API Cloudbees
date: '2011-12-29T08:34:00.006+01:00'
author: Alexis Hassler
tags:
- JavaEE
- CloudBees
modified_time: '2014-12-31T17:06:14.858+01:00'
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-3678343560842804277
blogger_orig_url: http://blog.alexis-hassler.com/2011/12/javaee-via-lapi-cloudbees.html

---

Dans un <a href="http://blog.alexis-hassler.com/2011/05/decouverte-de-cloudbees.html">billet précédent</a>, j'avais fait un premier essai de <a href="http://www.cloudbees.com/">Cloudbees</a>, en utilisant son interface graphique. Un des avantages offerts par les solutions Cloud est de pouvoir manipuler toute l'infrastructure par du code. Dans le cas de Cloudbees, le SDK permet de manipuler son compte et son contenu par des scripts Shell, via le SDK, mais aussi par une <a href="http://wiki.cloudbees.com/bin/view/RUN/API">API HTTP / XML</a>. Pour faciliter le travail, une <a href="https://github.com/cloudbees/cloudbees-api-client">API Java</a> a été développée au dessus de cette dernière.<br /><br />J'ai donc voulu tester le déploiement d'une application Java EE 6, empaquetée dans une archive war sur Cloudbees.<br /><br /><!--more--><br />Tout d'abord, j'ai ajouté l'artéfact de l'API java de Cloudbees dans mon pom.xml.<br /><pre class="brush:xml">&lt;dependency&gt;<br />    &lt;groupId&gt;com.cloudbees&lt;/groupId&gt;<br />    &lt;artifactId&gt;cloudbees-api-client&lt;/artifactId&gt;<br />    &lt;version&gt;1.1.2&lt;/version&gt;<br />&lt;/dependency&gt;</pre><br />Ensuite, j'ai instancié le BeesClient en lui passant l'URL de l'API, la clé et le code secret fournis par Cloudbees. Pour ce faire, j'ai stocké ces informations dans un fichier properties, afin de ne pas avoir à le réécrire à chaque fois et de ne pas avoir non plus à le stocker dans le code. Ma classe BeesClientBuilder se crée ce client en lui passant les informations du fichiers properties.<br /><br /><pre class="brush:java">public class BeesClientBuilder {<br />&nbsp; public static BeesClient build() {<br />&nbsp; &nbsp; try {<br />&nbsp; &nbsp; &nbsp; Properties properties = new Properties();<br />&nbsp; &nbsp; &nbsp; properties.load(new FileReader(System.getProperty("user.home")&nbsp;<br />                                + "/.cloudbees/cloudbees-api.properties"));<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />&nbsp; &nbsp; &nbsp; BeesClient client = new BeesClient(properties.getProperty("url"),<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;properties.getProperty("key"),<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;properties.getProperty("secret"),<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"xml", "1.0");<br />&nbsp; &nbsp; &nbsp; client.setVerbose(false);<br />&nbsp; &nbsp; &nbsp; return client;<br />&nbsp; &nbsp; } catch (IOException ex) {<br />&nbsp; &nbsp; &nbsp; throw new RuntimeException("Fichier properties non trouvé", ex);<br />&nbsp; &nbsp; }<br />&nbsp; }<br />}</pre><br />Je peux maintenant utiliser ce client dans ma classe principale. Je peux en particulier appeler la méthode applicationDeployWar, en lui passant en particulier l'id de l'application et le nom du fichier war.<br /><br /><pre class="brush:java">BeesClient client = BeesClientBuilder.build();<br />String appId = "sewatech/test";<br />ApplicationDeployArchiveResponse deployResponse0 <br />    = client.applicationDeployWar(appId, null, "Test war", <br />                                  "test.war", null, null);</pre><br />Le déploiement se fait, créant au passage l'application, mais celle-ci ne fonctionne pas car elle a été déployée comme un war simple et non un war JavaEE. Après un petit tour sur le forum, j'ai ma réponse (rapide, merci <a href="http://blog.loof.fr/">Nicolas</a>). Je dois ajouter des paramètres et donc utiliser la méthode&nbsp;applicationDeployArchive.<br /><br /><pre class="brush:java">Map&lt;string, string=""&gt; parameters = new HashMap&lt;string, string=""&gt;();<br />parameters.put("containerType", "jboss");<br />ApplicationDeployArchiveResponse deployResponse <br />    = client.applicationDeployArchive(appId, null, "Test war", <br />                                      "test.war", null, "war", <br />                                      true, parameters, null);</pre><br />Ainsi, mon application est directement créée et déployée sur une instance Java EE 6 de Cloudbees. Simple et efficace.<br /><br />Au passage, quelques autres commandes disponibles dans l'API.<br />Pour obtenir les informations sur une application :<br /><pre class="brush:java">ApplicationInfo info = client.applicationInfo(appId);</pre>Pour supprimer une application :<br /><pre class="brush:java">client.applicationDelete(appId);</pre>Pour renommer une application :<br /><pre class="brush:java">Map&lt;string, string&gt; meta = new HashMap&lt;string, string&gt;();<br />&nbsp; &nbsp; &nbsp; &nbsp; meta.put("title", "Test d'API");<br />&nbsp; &nbsp; &nbsp; &nbsp; client.applicationSetMeta(appId, meta);</pre><br /><br />En <b>conclusion</b>, l'API de Cloudbees est simple à mettre en oeuvre, avec une classe à connaître et des méthodes aux noms expressifs. En revanche, la documentation est loin d'être exhaustive (une mise à jour suite à ma question sur le forum) et, surtout, l'API est très loin d'être fluide. Le code que j'ai écrit est moche et très peu lisible : c'est quoi le 2° <i>null</i> ? En tout cas, ça fonctionne bien et c'est l'essentiel, pour le moment.