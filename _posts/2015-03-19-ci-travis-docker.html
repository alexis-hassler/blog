---
layout: post
title: Intégration continue avec Travis CI et Docker Hub
date: '2015-03-19T09:30:00.000+01:00'
author: Alexis Hassler
tags:
- Travis-CI
- Docker
- GitHub
- Bintray
modified_time: '2015-12-04T11:20:12.590+01:00'
thumbnail: "//3.bp.blogspot.com/-_N1Rbxidbz8/VQVtgXNRqFI/AAAAAAAAFvg/eKADo-TzhSw/s72-c/logos-ci-lite.png"
blogger_id: tag:blogger.com,1999:blog-1829028238633284708.post-2377867361425984141
blogger_orig_url: http://blog.alexis-hassler.com/2015/03/ci-travis-docker.html

---

Habituellement, je développe en java et j'utilise un Jenkins pour l'intégration continue. Récemment, j'ai développé un petit projet perso, pur front-end, ce qui est totalement nouveau pour moi ; le projet en question est une mini console d'administration pour WildFly.<br /><br />Pour être dans l'ère du temps, j'ai préparé une image Docker qui fait tourner un serveur Apache httpd sur lequel est déployée la console. Et pour faciliter l'utilisation et la distribution de cette image, elle est sur le <a href="http://hub.docker.com/" target="_blank">Hub Docker</a>. Voyons la chaîne d'intégration continue in ze cloud et gratuite qui met à jour mon image à chaque fois que mon code est mis à jour sur GitHub.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-_N1Rbxidbz8/VQVtgXNRqFI/AAAAAAAAFvg/eKADo-TzhSw/s1600/logos-ci-lite.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="//3.bp.blogspot.com/-_N1Rbxidbz8/VQVtgXNRqFI/AAAAAAAAFvg/eKADo-TzhSw/s1600/logos-ci-lite.png" height="100" width="320" /></a></div><br /><!--more--><br /><b>GitHub</b><br /><div class="separator" style="clear: both; text-align: center;"><br /></div>Le point de départ est le code source. Il est stocké dans un repository public sur GitHub.<br /><br /><b>Hub Docker et build automatique</b><br /><br />Le point d'arrivée est l'image Docker publiée sur le <a href="http://hub.docker.com/" target="_blank">Hub</a>. L'image y est construite directement avec un "build automatique" ; pour cela, j'ai mis un <a href="https://github.com/hasalex/docker-fly-ng/" target="_blank">Dockerfile</a> sur GitHub dans un repository dédié. A chaque mise à jour du Dockerfile, le build est relancé. Un build peut aussi être déclenché manuellement sur le site, ou en envoyant une requête à une certaine URL.<br /><pre class="brush: bash">curl --data "build=true" -X POST https://registry.hub.docker.com/u/$DOCKER_USERNAME/fly-ng/trigger/$DOCKER_KEY/<br /></pre>L'image Docker est construite sur la base de sewatech/apache qui est une Debian avec Apache Httpd à laquelle j'ajoute les fichiers de la console.<br /><br />Le but, maintenant, c'est de faire le build de l'application, avec gulp, de stocker l'archive construite pour qu'elle soit disponible pour la construction de l'image.<br /><pre class="brush: bash">FROM sewatech/apache<br />RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp;\ <br />    rm -r /var/www/html/* &amp;&amp;\<br />    (curl -skL https://bintray.com/artifact/download/hasalex/generic/fly-ng.tar.gz \<br />        | tar xfz - -C /var/www/html/)<br /></pre>Comme on peut le voir sur le script, l'archive contenant la console est téléchargée depuis <a href="https://bintray.com/hasalex/generic/fly-ng/" target="_blank">mon compte Bintray</a>.<br /><br /><b>Bintray</b><br /><br /><a href="https://bintray.com/" target="_blank">Bintray</a> héberge des repositories maven, debian, rpm, docker ou génériques. Un repository générique n'a pas de structure et de méta-données particulières, il peut stocker toute sorte de fichiers. Et Bintray est gratuit pour le stockage de fichiers sous licence open source.<br /><br />Pour uploader un fichier, on peut utiliser la ligne de commande avec curl.<br /><pre class="brush: bash">curl -T ./dist/fly-ng.tar.gz -H "X-Bintray-Publish: 1" -H "X-Bintray-Override: 1" -u$BT_USERNAME:$BT_KEY https://api.bintray.com/content/$BT_USERNAME/generic/fly-ng/0/fly-ng.tar.gz</pre><b><br /></b><b>Travis CI</b><br /><br />Travis CI est une plateforme d'intégration continue qui peut être utiliser gratuitement pour faire le build de repositories publics sur GitHub. Elle est capable de faire des builds pour Java, Ruby, ... et Node.JS. C'est cette dernière possibilité que j'exploite puisque j'utilise gulp pour mon petit projet et que gulp tourne sur Node.JS.<br /><br />Il a donc fallu faire une tâche qui prépare l'environnement de build, qui exécute le build gulp complet, puis qui upload l'archive obtenue sur Bintray et enfin qui déclenche le build Docker directement sur le Hub.<br /><pre class="brush: js">language: node_js<br />node_js:<br />&nbsp; - "0.10"<br />before_script:<br />&nbsp; - npm install -g gulp<br />&nbsp; - sudo apt-get update -qq<br />&nbsp; - sudo apt-get install -y curl<br />script:<br />&nbsp; - gulp archive<br />after_success:<br />&nbsp; - "curl -T ./dist/fly-ng.tar.gz -H \"X-Bintray-Publish: 1\" -H \"X-Bintray-Override: 1\" -u$BT_USERNAME:$BT_KEY https://api.bintray.com/content/$BT_USERNAME/generic/fly-ng/0/fly-ng.tar.gz"<br />&nbsp; - "curl --data \"build=true\" -X POST https://registry.hub.docker.com/u/$DOCKER_USERNAME/fly-ng/trigger/$DOCKER_KEY/"<b><br /></b></pre><b><br /></b><b>Conclusion</b><br /><br />GitHub + Travis CI + Bintray + Docker Hub, voici ma chaîne d'intégration continue gratuite.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-0nQFyv194Mc/VQVsYa2DHkI/AAAAAAAAFvQ/XNHynua34zA/s1600/logos-ci.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" src="//3.bp.blogspot.com/-0nQFyv194Mc/VQVsYa2DHkI/AAAAAAAAFvQ/XNHynua34zA/s1600/logos-ci.png" height="95" width="400" /></a></div><br /><br />Avec elle, à chaque fois que je fais une mise à jour de mon repository GitHub, ça déclenche le build TravisCI, qui déclenche la construction d'une nouvelle version de l'image Docker. Parfait pour ce petit projet.